<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RATIO Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f4f4f9);
            --tg-text: var(--tg-theme-text-color, #333);
            --tg-hint: var(--tg-theme-hint-color, #999);
            --tg-link: var(--tg-theme-link-color, #248bfe);
            --primary: #1a7f37;
        }
        body { 
            font-family: -apple-system, system-ui, Roboto, sans-serif; 
            background: var(--tg-bg); 
            color: var(--tg-text);
            margin: 0; padding: 15px; 
            overscroll-behavior: none;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .card { 
            background: var(--tg-theme-secondary-bg-color, #fff); 
            padding: 20px; border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        .field-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85em; margin-bottom: 5px; color: var(--tg-hint); }
        input, select { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; font-size: 16px; 
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-text);
        }
        .base-row { display: flex; gap: 10px; }
        .base-row select { flex: 2; }
        .base-row input { flex: 1; background: var(--tg-theme-secondary-bg-color, #eee); }

        .result-box { 
            text-align: center; background: rgba(26, 127, 55, 0.1); 
            padding: 15px; border-radius: 10px; margin: 15px 0;
            border: 1px solid var(--primary);
        }
        .result-val { font-size: 32px; font-weight: bold; color: var(--primary); }
        .formula-text { font-size: 11px; color: var(--tg-hint); margin-top: 5px; }

        button { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; 
            font-weight: bold; cursor: pointer; margin-bottom: 10px; 
            font-size: 14px; transition: 0.2s;
        }
        .btn-main { background: var(--tg-theme-button-color, var(--primary)); color: var(--tg-theme-button-text-color, #fff); }
        .btn-sec { background: #666; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--tg-link); color: var(--tg-link); }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; }
        .modal-content { background: var(--tg-bg); margin: 10% auto; padding: 20px; width: 85%; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .history-item { font-family: monospace; font-size: 11px; border-bottom: 1px solid #ddd; padding: 8px 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="field-group">
            <label>–ó–Ω–∞—á–µ–Ω–∏–µ A (1-100):</label>
            <input type="number" id="valA" value="46" oninput="calculate()">
        </div>
        <div class="field-group">
            <label>–ó–Ω–∞—á–µ–Ω–∏–µ B:</label>
            <input type="number" id="valB" value="2.4" step="0.1" oninput="calculate()">
        </div>
        <div class="field-group">
            <label>–ó–Ω–∞—á–µ–Ω–∏–µ D:</label>
            <input type="number" id="valD" value="145" oninput="calculate()">
        </div>
        <div class="field-group">
            <label>–ë–∞–∑–∞ (C):</label>
            <div class="base-row">
                <select id="baseSelect" onchange="onBaseChange()"></select>
                <input type="text" id="valC" readonly>
            </div>
        </div>
    </div>

    <div class="card">
        <label>–§–æ—Ä–º—É–ª–∞:</label>
        <input type="text" id="formula" value="(({A} * {B} + {C}) / {D}) * 100 - 100" oninput="calculate()">
        <div class="result-box">
            <div class="result-val" id="resDisplay">0.00 %</div>
            <div class="formula-text" id="detailsDisplay">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <button class="btn-main" onclick="saveToHistory()">‚úÖ –°–û–•–†–ê–ù–ò–¢–¨ –í –ò–°–¢–û–†–ò–Æ</button>
    <button class="btn-outline" onclick="openEditor()">‚öô –†–ï–î–ê–ö–¢–û–† –ë–ê–ó–´</button>
    <button class="btn-sec" onclick="openHistory()">üìú –ò–°–¢–û–†–ò–Ø –†–ê–°–ß–ï–¢–û–í</button>
</div>

<div id="modalHistory" class="modal" onclick="closeModals()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div id="historyList"></div>
        <button class="btn-sec" onclick="clearHistory()" style="background:#d33; margin-top:10px;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        <button class="btn-outline" onclick="closeModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="modalEditor" class="modal" onclick="closeModals()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –±–∞–∑—ã</h3>
        <table id="baseTable">
            <thead><tr><th>–ò–º—è</th><th>C</th><th></th></tr></thead>
            <tbody id="baseTableBody"></tbody>
        </table>
        <button class="btn-main" onclick="addNewBase()" style="margin-top:10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn-sec" onclick="resetBases()" style="background:#f39c12;">üîÑ –°–±—Ä–æ—Å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º</button>
        <button class="btn-outline" onclick="closeModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const DEFAULT_BASES = {
    "6 –õ–ï–†–£–ê": 8.64,
    "8 –õ–ï–†–£–ê": 10.56,
    "10 –õ–ï–†–£–ê": 12.48,
    "12 –õ–ï–†–£–ê": 9.36,
    "8 HARD": 5.76,
    "10 HARD": 6.72,
    "8 –ì–û–°–¢": 9.96,
    "10 –ì–û–°–¢": 8.16,
    "6 ST": 7.68,
    "8 ST": 9.6,
    "10 ST": 11.52,
    "12 ST": 12.96,
    "4 PRO": 3.84,
    "6 PRO": 8.64,
    "8 PRO": 10.56,
    "10 PRO": 12.48,
    "12 PRO": 12.96,
    "14 PRO": 10.56,
    "16 PRO": 10.8
    };

    let BASES;

    function init() {
        loadBases();
        renderBaseSelect();
        calculate();
    }

    function loadBases() {
        let saved = localStorage.getItem('bases');
        if (!saved) {
            BASES = { ...DEFAULT_BASES };
        } else {
            BASES = JSON.parse(saved);
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–ª—é—á–∏ –∏–∑ –∫–æ–¥–∞, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ –ø–∞–º—è—Ç–∏
            Object.keys(DEFAULT_BASES).forEach(key => {
                if (!(key in BASES)) BASES[key] = DEFAULT_BASES[key];
            });
        }
    }

    function renderBaseSelect() {
        const sel = document.getElementById('baseSelect');
        const lastVal = sel.value;
        sel.innerHTML = '';
        Object.keys(BASES).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name; opt.textContent = name;
            sel.appendChild(opt);
        });
        if (lastVal && BASES[lastVal]) sel.value = lastVal;
        onBaseChange();
    }

    function onBaseChange() {
        const name = document.getElementById('baseSelect').value;
        document.getElementById('valC').value = BASES[name] || 0;
        calculate();
    }

    function calculate() {
        try {
            const a = document.getElementById('valA').value || "0";
            const b = document.getElementById('valB').value || "0";
            const c = document.getElementById('valC').value || "0";
            const d = document.getElementById('valD').value || "1";
            let f = document.getElementById('formula').value;

            let readyF = f.replace(/{A}/g, a).replace(/{B}/g, b).replace(/{C}/g, c).replace(/{D}/g, d);
            const res = eval(readyF.replace(/[^-()\d/*+.]/g, ''));
            
            document.getElementById('resDisplay').textContent = res.toFixed(2) + " %";
            document.getElementById('detailsDisplay').textContent = "–§–æ—Ä–º—É–ª–∞: " + readyF;
            return { f: readyF, res: res.toFixed(2) };
        } catch (e) {
            document.getElementById('resDisplay').textContent = "---";
        }
    }

    function saveToHistory() {
        const data = calculate();
        if (!data) return;
        const history = JSON.parse(localStorage.getItem('calc_history')) || [];
        const time = new Date().toLocaleString('ru-RU', {hour:'2-digit', minute:'2-digit'});
        history.unshift(`[${time}] ${data.f} = ${data.res}%`);
        localStorage.setItem('calc_history', JSON.stringify(history.slice(0, 30)));
        
        // –í–∏–±—Ä–∞—Ü–∏—è Telegram
        tg.HapticFeedback.notificationOccurred('success');
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
    }

    function resetBases() {
        if(confirm("–í–µ—Ä–Ω—É—Ç—å –±–∞–∑—É –∏–∑ —Ñ–∞–π–ª–∞?")) {
            localStorage.removeItem('bases');
            location.reload();
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–º–æ–¥–∞–ª–∫–∏, —É–¥–∞–ª–µ–Ω–∏–µ)
    function openHistory() {
        const history = JSON.parse(localStorage.getItem('calc_history')) || [];
        document.getElementById('historyList').innerHTML = history.map(i => `<div class="history-item">${i}</div>`).join('') || "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞";
        document.getElementById('modalHistory').style.display = 'block';
    }

    function openEditor() {
        const body = document.getElementById('baseTableBody');
        body.innerHTML = '';
        Object.entries(BASES).forEach(([name, val]) => {
            const row = `<tr><td>${name}</td><td>${val}</td><td><button onclick="deleteBase('${name}')" style="background:#d33; padding:5px; margin:0; width:auto;">X</button></td></tr>`;
            body.insertAdjacentHTML('beforeend', row);
        });
        document.getElementById('modalEditor').style.display = 'block';
    }

    function deleteBase(name) {
        delete BASES[name];
        saveBases();
    }

    function addNewBase() {
        const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:");
        const v = parseFloat(prompt("–ó–Ω–∞—á–µ–Ω–∏–µ C:"));
        if(n && !isNaN(v)) { BASES[n] = v; saveBases(); }
    }

    function saveBases() {
        localStorage.setItem('bases', JSON.stringify(BASES));
        renderBaseSelect();
        openEditor();
    }

    function clearHistory() { 
        localStorage.removeItem('calc_history'); 
        openHistory(); 
    }

    function closeModals() { 
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
    }

    init();
</script>
</body>
</html>

